name: E2E Tests Failure Handler
run-name: E2E Tests Failed

on:
  repository_dispatch:
    types: [trigger_event_from_tests_failed, e2e_tests_failed_from_pr]

jobs:
  tests_done:
    runs-on: ubuntu-latest
    steps:
      - name: Display test result
        run: echo "E2E tests failed"
      
      - name: Update commit status to failure
        if: github.event.client_payload.commit_sha
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.event.client_payload.commit_sha }} \
            -d '{
              "state": "failure",
              "context": "E2E Tests (External)",
              "description": "E2E tests failed - merge blocked",
              "target_url": "${{ github.event.client_payload.test_run_url || format('https://github.com/SAP/gigya-mobile-sdk-tests/actions') }}"
            }'
      
      - name: Comment on PR
        if: github.event.client_payload.pr_number
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.client_payload.pr_number }}/comments \
            -d '{
              "body": "‚ùå **E2E Tests Failed**\n\nExternal end-to-end tests have failed. Please review the test results and fix any issues before merging.\n\n[View test results](https://github.com/SAP/gigya-mobile-sdk-tests/actions)"
            }'
      
      - name: Fail the workflow
        run: exit 1
